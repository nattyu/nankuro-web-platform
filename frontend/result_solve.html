<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solution - Nankuro Sender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #475569;
            font-weight: bold;
            position: relative;
        }

        .cell.block {
            background-color: #334155;
        }

        .cell.empty {
            background-color: #1e293b;
        }

        .cell .num {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 8px;
            color: #94a3b8;
        }

        .cell .char {
            font-size: 20px;
            color: #e2e8f0;
        }

        .cell .conf {
            position: absolute;
            bottom: -15px;
            right: 0;
            font-size: 8px;
            background: #0f172a;
            padding: 1px 3px;
            border-radius: 2px;
            color: #22d3ee;
            display: none;
            z-index: 10;
        }

        .cell:hover .conf {
            display: block;
        }

        .mapping-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            text-align: center;
            padding: 4px;
            }

            .mapping-num {
            font-size: 12px;
            color: #94a3b8;
            height: 20%;
            }

            .mapping-kanji {
            font-size: 22px;
            font-weight: bold;
            height: 80%;
            }
    </style>
</head>

<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-4xl flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">Solution
        </h1>
        <a href="main.html" class="text-sm text-slate-400 hover:text-white underline">Back to Home</a>
    </div>

    <div id="mappingBar"
        class="w-full max-w-4xl mb-4 grid grid-cols-5 sm:grid-cols-10 gap-2">
    </div>

    <div
        class="bg-slate-800 p-6 rounded-xl shadow-xl border border-slate-700 w-full max-w-4xl overflow-auto flex justify-center">
        <div id="gridContainer" class="grid gap-0 bg-slate-700 border border-slate-600">
            <!-- Grid generated by JS -->
            <div class="p-10 text-slate-400">Thinking...</div>
        </div>
    </div>

    <div id="metaInfo" class="mt-6 text-slate-400 text-sm bg-slate-900 p-4 rounded border border-slate-800">
        <!-- Meta info -->
    </div>

    <script>
        const API_URL = "https://api.nankuro-assist.com/api/solve";

        function todayJST() {
            // JSTの日付文字列（YYYY-MM-DD）
            const now = new Date();
            // 端末が日本前提ならこれでOK。厳密化するならサーバ返却に寄せる。
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function renderGrid(board, result) {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';

            const solutions = result.mapping || [];
            const solMap = {};
            solutions.forEach(s => { solMap[`${s.row},${s.col}`] = s; });

            const rows = board.length;
            const cols = board[0].length;

            container.style.gridTemplateColumns = `repeat(${cols}, 40px)`;
            container.style.gridTemplateRows = `repeat(${rows}, 40px)`;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cellVal = board[r][c];
                    const div = document.createElement('div');
                    div.className = 'cell';

                    if (cellVal === '■') {
                    div.classList.add('block');
                    } else {
                    div.classList.add('empty');

                    const spanNum = document.createElement('span');
                    spanNum.className = 'num';
                    spanNum.innerText = cellVal;
                    div.appendChild(spanNum);

                    const sol = solMap[`${r},${c}`];
                    if (sol) {
                        const spanChar = document.createElement('span');
                        spanChar.className = 'char';
                        spanChar.innerText = sol.char;
                        div.appendChild(spanChar);

                        if (sol.conf !== undefined) {
                        const spanConf = document.createElement('span');
                        spanConf.className = 'conf';
                        spanConf.innerText = (sol.conf * 100).toFixed(0) + "%";
                        div.appendChild(spanConf);
                        }
                    }
                    }
                    container.appendChild(div);
                }
            }

            const metaDiv = document.getElementById('metaInfo');
            metaDiv.innerHTML = `
            <p>Status: <span class="text-blue-400">${result.status}</span></p>
            <p>Puzzle ID: ${result.puzzle_id || 'N/A'}</p>
            <p>Visible Solutions: ${solutions.length}</p>
            ${result.meta?.limited ? '<p class="text-yellow-400">⚠ Display Limited (Free Plan)</p>' : ''}
            `;
        }

        function renderMapping(mapping) {
            const bar = document.getElementById("mappingBar");
            bar.innerHTML = "";

            mapping.forEach(m => {
                const card = document.createElement("div");

                let color = "border-yellow-400";
                if (m.conf >= 0.9) color = "border-blue-400";
                else if (m.conf >= 0.7) color = "border-green-400";

                card.className = `
                w-14 h-20 rounded-lg border ${color}
                flex flex-col items-center justify-between p-1
                bg-slate-800 text-white
                `;

                card.innerHTML = `
                <div class="text-xs text-slate-400">#${m.num}</div>
                <div class="text-2xl font-bold">${m.kanji}</div>
                <div class="text-[10px] text-slate-400">${Math.round(m.conf*100)}%</div>
                `;

                bar.appendChild(card);
            });
            }



        async function solve() {
            const plan = localStorage.getItem('nankuro_plan') || 'free';
            const board = JSON.parse(localStorage.getItem('nankuro_board') || "null");
            if (!board) {
            document.getElementById('gridContainer').innerHTML =
                `<div class="text-red-400">board が見つかりません。先に main.html でOCRしてください。</div>`;
            return;
            }

            try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                'X-Plan': plan
                },
                body: JSON.stringify({ board })
            });

            if (response.status === 429) {
                const data = await response.json();

                // メッセージ表示
                document.getElementById('gridContainer').innerHTML = `
                    <div class="text-yellow-300 text-center p-6">
                    <p class="text-lg font-semibold">本日の上限に達しました</p>
                    <p class="text-sm text-slate-400 mt-2">
                        無料利用は1日5回までです。明日またお試しください。
                    </p>
                    </div>
                `;

                // ボタン非活性用
                localStorage.setItem('nankuro_solve_blocked_day', todayJST());

                return;
                }


            if (!response.ok) {
                const text = await response.text();
                throw new Error(`API Error ${response.status}: ${text}`);
            }

            const result = await response.json();
            renderGrid(board, result);

            } catch (e) {
            console.error(e);
            document.getElementById('gridContainer').innerHTML =
                `<div class="text-red-400">Error: ${e.message}</div>`;
            }
        }

        solve();
        renderMapping(result.mapping || []);

    </script>
</body>

</html>