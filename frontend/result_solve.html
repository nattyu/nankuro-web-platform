<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solution - Nankuro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .cell {
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      border: 1px solid #475569; font-weight: bold; position: relative;
    }
    .cell.block { background-color: #334155; }
    .cell.empty { background-color: #1e293b; }
    .cell .num {
      position: absolute; top: 2px; left: 2px;
      font-size: 8px; color: #94a3b8;
    }
    .cell .char { font-size: 20px; color: #e2e8f0; }
    .cell .conf {
      position: absolute; bottom: -15px; right: 0;
      font-size: 8px; background: #0f172a; padding: 1px 3px;
      border-radius: 2px; color: #22d3ee; display: none; z-index: 10;
    }
    .cell:hover .conf { display: block; }
  </style>
</head>

<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-4">
  <div class="w-full max-w-4xl flex justify-between items-center mb-8">
    <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">Solution</h1>
    <a href="main.html" class="text-sm text-slate-400 hover:text-white underline">Back to Home</a>
  </div>

  <!-- mapping bar -->
  <div id="mappingBar" class="w-full max-w-4xl mb-4 grid grid-cols-5 sm:grid-cols-10 gap-2"></div>

  <!-- grid -->
  <div class="bg-slate-800 p-6 rounded-xl shadow-xl border border-slate-700 w-full max-w-4xl overflow-auto flex justify-center">
    <div id="gridContainer" class="grid gap-0 bg-slate-700 border border-slate-600">
      <div class="p-10 text-slate-400">Thinking...</div>
    </div>
  </div>

  <div id="metaInfo" class="mt-6 text-slate-400 text-sm bg-slate-900 p-4 rounded border border-slate-800"></div>

  <script>
    const API_URL = "https://api.nankuro-assist.com/api/solve";

    function buildNumToMap(mapping) {
      const m = new Map();
      (mapping || []).forEach(x => {
        // num は number の想定。文字列でも一応吸収
        const key = String(x.num);
        m.set(key, x);
      });
      return m;
    }

    function renderMapping(mapping) {
      const bar = document.getElementById("mappingBar");
      bar.innerHTML = "";

      (mapping || []).forEach(m => {
        const conf = (typeof m.conf === "number") ? m.conf : null;

        let color = "border-yellow-400";
        if (conf !== null) {
          if (conf >= 0.9) color = "border-blue-400";
          else if (conf >= 0.7) color = "border-green-400";
          else color = "border-yellow-400";
        }

        const card = document.createElement("div");
        card.className = `
          w-14 h-20 rounded-lg border ${color}
          flex flex-col items-center justify-between p-1
          bg-slate-800 text-white
        `;

        card.innerHTML = `
          <div class="text-xs text-slate-400">#${m.num}</div>
          <div class="text-2xl font-bold">${m.kanji ?? ""}</div>
          <div class="text-[10px] text-slate-400">${conf === null ? "" : (Math.round(conf*100) + "%")}</div>
        `;

        bar.appendChild(card);
      });
    }

    function renderGridFromMapping(board, mapping) {
      const container = document.getElementById('gridContainer');
      container.innerHTML = "";

      const numMap = buildNumToMap(mapping);

      const rows = board.length;
      const cols = board[0].length;
      container.style.gridTemplateColumns = `repeat(${cols}, 40px)`;
      container.style.gridTemplateRows = `repeat(${rows}, 40px)`;

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const cellVal = board[r][c];
          const div = document.createElement('div');
          div.className = 'cell';

          if (cellVal === '■') {
            div.classList.add('block');
            container.appendChild(div);
            continue;
          }

          div.classList.add('empty');

          // OCRのセル値が漢字なら、そのまま出す
          const isDigit = /^\d+$/.test(String(cellVal));
          if (isDigit) {
            // 左上の数字
            const spanNum = document.createElement('span');
            spanNum.className = 'num';
            spanNum.innerText = String(cellVal);
            div.appendChild(spanNum);

            // mapping があれば漢字を置換表示
            const hit = numMap.get(String(cellVal));
            if (hit) {
              const spanChar = document.createElement('span');
              spanChar.className = 'char';
              spanChar.innerText = hit.kanji ?? "";
              div.appendChild(spanChar);

              if (typeof hit.conf === "number") {
                const spanConf = document.createElement('span');
                spanConf.className = 'conf';
                spanConf.innerText = Math.round(hit.conf * 100) + "%";
                div.appendChild(spanConf);
              }
            }
          } else {
            // 数字じゃない（漢字など）はそのまま中央表示
            const spanChar = document.createElement('span');
            spanChar.className = 'char';
            spanChar.innerText = String(cellVal ?? "");
            div.appendChild(spanChar);
          }

          container.appendChild(div);
        }
      }
    }

    async function solve() {
      const plan = localStorage.getItem('nankuro_plan') || 'free';
      const board = JSON.parse(localStorage.getItem('nankuro_board') || "null");
      const puzzle_id = localStorage.getItem('nankuro_puzzle_id') || "unknown";

      if (!board) {
        document.getElementById('gridContainer').innerHTML =
          `<div class="text-red-400">board が見つかりません。先に main.html でOCRしてください。</div>`;
        return;
      }

      function getOrCreateDeviceId() {
        const KEY = "nankuro_device_id";
        let id = localStorage.getItem(KEY);
        if (id) return id;

        // main.html と同じ生成ロジック（安全版）
        if (window.crypto && window.crypto.randomUUID) {
          id = window.crypto.randomUUID();
        } else {
          id = "dev-" + Math.random().toString(16).slice(2) + "-" + Date.now();
        }
        localStorage.setItem(KEY, id);
        return id;
      }

      const device_id = getOrCreateDeviceId();

      try {
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Plan': plan,
            'X-Device-Id': device_id,
          },
          body: JSON.stringify({
            board: board, 
            puzzle_id: puzzle_id
          })
        });

        // 429 はそのまま表示したい（free上限）
        if (resp.status === 429) {
          const j = await resp.json();
          document.getElementById('metaInfo').innerHTML = `
            <p class="text-yellow-300">${j.message || "本日の無料利用回数に達しました"}</p>
          `;
          // 盤面はOCRのまま表示
          renderMapping([]);
          renderGridFromMapping(board, []);
          return;
        }

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`API Error ${resp.status}: ${text}`);
        }

        const result = await resp.json();

        const mapping = result.mapping || [];
        renderMapping(mapping);
        renderGridFromMapping(board, mapping);

        const metaDiv = document.getElementById('metaInfo');
        metaDiv.innerHTML = `
          <p>Status: <span class="text-blue-400">${result.status ?? "ok"}</span></p>
          <p>Puzzle ID: ${result.puzzle_id || puzzle_id}</p>
          <p>Visible Vars: ${mapping.length}</p>
          ${result.meta?.limited ? '<p class="text-yellow-400">⚠ Display Limited (Free Plan)</p>' : ''}
        `;

      } catch (e) {
        console.error(e);
        document.getElementById('gridContainer').innerHTML =
          `<div class="text-red-400">Error: ${e.message}</div>`;
      }
    }

    solve();
  </script>
</body>
</html>
