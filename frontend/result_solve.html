<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solution - Nankuro Sender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #475569;
            font-weight: bold;
            position: relative;
        }

        .cell.block {
            background-color: #334155;
        }

        .cell.empty {
            background-color: #1e293b;
        }

        .cell .num {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 8px;
            color: #94a3b8;
        }

        .cell .char {
            font-size: 20px;
            color: #e2e8f0;
        }

        .cell .conf {
            position: absolute;
            bottom: -15px;
            right: 0;
            font-size: 8px;
            background: #0f172a;
            padding: 1px 3px;
            border-radius: 2px;
            color: #22d3ee;
            display: none;
            z-index: 10;
        }

        .cell:hover .conf {
            display: block;
        }
    </style>
</head>

<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-4xl flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">Solution
        </h1>
        <a href="main.html" class="text-sm text-slate-400 hover:text-white underline">Back to Home</a>
    </div>

    <div
        class="bg-slate-800 p-6 rounded-xl shadow-xl border border-slate-700 w-full max-w-4xl overflow-auto flex justify-center">
        <div id="gridContainer" class="grid gap-0 bg-slate-700 border border-slate-600">
            <!-- Grid generated by JS -->
            <div class="p-10 text-slate-400">Thinking...</div>
        </div>
    </div>

    <div id="metaInfo" class="mt-6 text-slate-400 text-sm bg-slate-900 p-4 rounded border border-slate-800">
        <!-- Meta info -->
    </div>

    <script>
        // CONFIG
        // Change this URL after deploying to AWS
        const API_URL = "https://p66jj3rlb5.execute-api.ap-northeast-1.amazonaws.com/api/solve";

        async function solve() {
            const plan = localStorage.getItem('nankuro_plan') || 'free';
            const user_id = "test_user_" + Math.floor(Math.random() * 1000);

            // Dummy Board for demo
            // ■ #1 #2
            // #3 #1 #4
            const board = [
                ["■", "1", "2"],
                ["3", "1", "4"]
            ];

            try {
                // If we are calling the local python API directly, it might not support 'plan' in auth header easily without extra setup.
                // However, our local_api.py doesn't check auth header for logic, it just passes user_id.
                // But wait, our lambda_handler does check auth!
                // Since local_api.py is just a wrapper for solver_core, it doesn't have the restriction logic of lambda_handler.
                // To test restriction logic LOCALLY, we'd need to simulate it in JS or modify local_api.py.
                // OR, we assume we are hitting the Lambda URL which does logic.

                // For this demo, since we are likely running local_api.py (FastAPI) which returns RAW results without restriction logic (unless we added it there?), 
                // Let's assume the API returns full results and we simulate the restriction on Client if hitting local?
                // NO, the requirement was "Backend logic".
                // Our local_api.py calls `solve_nankuro` directly. It DOES NOT call `apply_plan_restrictions`.
                // So local_api.py returns FULL results always.

                // To properly verify the UI handling of restrictions, we should probably update local_api.py to include restriction logic optionally,
                // OR just accept that local testing shows full results and we trust the verify_phase2.py for logic.

                // Let's send the request.
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ board: board, user_id: user_id })
                });

                if (!response.ok) throw new Error("API Error");
                const result = await response.json();

                // If result is unrestricted (local API), we might want to manually restrict it here JUST FOR DEMO VISUALIZATION
                // if we are testing the UI for Free users. 
                // But normally the UI just renders what it gets.

                renderGrid(board, result);

            } catch (e) {
                console.error(e);
                document.getElementById('gridContainer').innerHTML = `<div class="text-red-400">Error: ${e.message}. Is the local API running?</div>`;
            }
        }

        function renderGrid(board, result) {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';

            const solutions = result.solutions || [];
            // Map solutions for easy lookup: key = "row,col"
            const solMap = {};
            solutions.forEach(s => {
                solMap[`${s.row},${s.col}`] = s;
            });

            const rows = board.length;
            const cols = board[0].length;

            container.style.gridTemplateColumns = `repeat(${cols}, 40px)`;
            container.style.gridTemplateRows = `repeat(${rows}, 40px)`;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cellVal = board[r][c];
                    const div = document.createElement('div');
                    div.className = 'cell';

                    if (cellVal === '■') {
                        div.classList.add('block');
                    } else {
                        div.classList.add('empty');
                        // Helper number
                        const spanNum = document.createElement('span');
                        spanNum.className = 'num';
                        spanNum.innerText = cellVal;
                        div.appendChild(spanNum);

                        // Solution Char
                        const sol = solMap[`${r},${c}`];
                        if (sol) {
                            const spanChar = document.createElement('span');
                            spanChar.className = 'char';
                            spanChar.innerText = sol.char;
                            div.appendChild(spanChar);

                            // Conf (if present)
                            if (sol.conf !== undefined) {
                                const spanConf = document.createElement('span');
                                spanConf.className = 'conf';
                                spanConf.innerText = (sol.conf * 100).toFixed(0) + "%";
                                div.appendChild(spanConf);
                                div.style.borderColor = "#22d3ee"; // Highlight confident cells
                            }
                        }
                    }
                    container.appendChild(div);
                }
            }

            // Meta Info
            const metaDiv = document.getElementById('metaInfo');
            metaDiv.innerHTML = `
                <p>Status: <span class="text-blue-400">${result.status}</span></p>
                <p>Puzzle ID: ${result.puzzle_id || 'N/A'}</p>
                <p>Visible Solutions: ${solutions.length}</p>
                ${result.meta?.limited ? '<p class="text-yellow-400">⚠ Display Limited (Free Plan)</p>' : ''}
            `;
        }

        // Run on load
        solve();
    </script>
</body>

</html>