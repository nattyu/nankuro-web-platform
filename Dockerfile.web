# ===== Base image =====
FROM python:3.11-slim

# ===== OS deps (for OpenCV / libGL) =====
# libgl1  -> provides libGL.so.1
# libglib2.0-0 -> often required by OpenCV
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgl1 \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# ===== Environment =====
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    HOME=/tmp \
    MPLCONFIGDIR=/tmp \
    YOLO_CONFIG_DIR=/tmp \
    ULTRALYTICS_NO_AUTOINSTALL=True \
    YOLO_VERBOSE=False

WORKDIR /app

# ===== Install Python deps =====
# Copy requirements first for better layer caching
COPY requirements.txt /app/requirements.txt
RUN python -m pip install --upgrade pip \
 && python -m pip install --no-cache-dir -r /app/requirements.txt

# ===== Copy app source =====
COPY . /app

# ===== App Runner expects app listens on 8080 =====
EXPOSE 8080

# ===== Start =====
# (Hypercorn is fine; App Runner TCP health check will pass if this starts)
CMD ["python3", "-m", "hypercorn", "lambda_app.web_app:app", "--bind", "0.0.0.0:8080", "--log-level", "info", "--access-logfile", "-", "--error-logfile", "-"]
